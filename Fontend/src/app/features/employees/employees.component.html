<div class="space-y-6">
  <!-- Header -->
  <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
    <h2 class="text-2xl font-bold text-slate-800">พนักงาน (Employees)</h2>
    <app-button variant="primary" icon="user-plus" (onClick)="handleAddClick()">เพิ่มพนักงาน</app-button>
  </div>

  <!-- Search and Filters -->
  <div class="bg-white rounded-xl border border-slate-200 p-4 space-y-4">
    <!-- Search Bar -->
    <div class="flex flex-col sm:flex-row gap-3">
      <div class="flex-1">
        <input
          type="text"
          [value]="searchKeyword()"
          (input)="searchKeyword.set($any($event.target).value)"
          (keyup.enter)="onSearch()"
          placeholder="ค้นหาพนักงาน (ชื่อ, เบอร์โทร)..."
          class="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 outline-none"
        />
      </div>
      <app-button variant="primary" (onClick)="onSearch()">ค้นหา</app-button>
      @if (hasActiveFilters()) {
        <app-button variant="secondary" (onClick)="clearFilters()">ล้างตัวกรอง</app-button>
      }
    </div>

    <!-- Filters -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 pt-3 border-t border-slate-200">
      <div>
        <label class="block text-xs font-medium text-slate-600 mb-1">สถานะ</label>
        <select
          [value]="filterStatus()"
          (change)="filterStatus.set($any($event.target).value); onFilterChange()"
          class="w-full p-2 text-sm border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 outline-none bg-white">
          <option value="All">ทั้งหมด</option>
          <option value="Active">Active</option>
          <option value="Inactive">Inactive</option>
        </select>
      </div>
      <div>
        <label class="block text-xs font-medium text-slate-600 mb-1">แผนก</label>
        <select
          [value]="filterDepartmentId()"
          (change)="onFilterDepartmentChange($any($event.target).value)"
          class="w-full p-2 text-sm border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 outline-none bg-white">
          <option value="All">ทั้งหมด</option>
          @for (dept of departments(); track dept.id) {
            <option [value]="dept.id">{{ dept.name }}</option>
          }
        </select>
      </div>
      <div>
        <label class="block text-xs font-medium text-slate-600 mb-1">ตำแหน่ง</label>
        <select
          [value]="filterPositionId()"
          (change)="filterPositionId.set($any($event.target).value); onFilterChange()"
          [disabled]="filterDepartmentId() === 'All'"
          class="w-full p-2 text-sm border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 outline-none bg-white disabled:bg-slate-100 disabled:cursor-not-allowed">
          <option value="All">ทั้งหมด</option>
          @if (filterDepartmentId() !== 'All') {
            @for (pos of positions(); track pos.id) {
              <option [value]="pos.id">{{ pos.name }}</option>
            }
          }
        </select>
      </div>
      <div>
        <label class="block text-xs font-medium text-slate-600 mb-1">จำนวนต่อหน้า</label>
        <select
          [value]="pageSize()"
          (change)="onPageSizeChange(+$any($event.target).value)"
          class="w-full p-2 text-sm border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 outline-none bg-white">
          <option value="5">5</option>
          <option value="10">10</option>
          <option value="20">20</option>
          <option value="50">50</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Error Message -->
  @if (errorMessage()) {
    <div class="bg-red-50 border border-red-200 rounded-lg p-3 flex items-center gap-2">
      <app-icon name="alert-circle" class="text-red-600" size="20"></app-icon>
      <span class="text-sm text-red-600">{{ errorMessage() }}</span>
    </div>
  }

  <!-- Loading State -->
  @if (isLoading()) {
    <div class="flex justify-center items-center py-12">
      <app-icon name="loader-2" class="animate-spin text-indigo-600" size="32"></app-icon>
    </div>
  }

  <!-- Employees Table -->
  <app-table
    [columns]="tableColumns()"
    [data]="employees()"
    [pagination]="getTablePagination()"
    [loading]="isLoading()"
    [currentSortKey]="sortBy()"
    [currentSortDirection]="sortDirection()"
    emptyMessage="ไม่พบข้อมูลพนักงาน"
    [trackByFn]="trackByEmployeeId"
    (pageChange)="onPageChange($event)"
    (pageSizeChange)="onPageSizeChange($event)"
    (sortChange)="onSortChange($event)">
    
    <!-- Custom template for name column -->
    <ng-template #nameTemplate let-emp>
      <div class="flex items-center gap-3">
        <app-avatar [src]="emp.avatar" [alt]="emp.name" size="md"></app-avatar>
        <div>
          <div class="font-medium text-slate-800">{{ emp.name }}</div>
          @if (emp.phone) {
            <div class="text-xs text-slate-500">{{ emp.phone }}</div>
          }
        </div>
      </div>
    </ng-template>

    <!-- Custom template for status column -->
    <ng-template #statusTemplate let-emp>
      <app-badge [status]="getStatusBadge(emp.status)"></app-badge>
    </ng-template>

    <!-- Custom template for actions column -->
    <ng-template #actionsTemplate let-emp>
      <div class="flex items-center justify-end gap-2">
        <app-action-button variant="edit" title="แก้ไข" (onClick)="handleEditClick(emp)"></app-action-button>
        <app-action-button variant="delete" title="ลบ" (onClick)="handleDelete(emp.id)"></app-action-button>
      </div>
    </ng-template>
  </app-table>

  <!-- Add/Edit Modal -->
  <app-modal 
    [isOpen]="isModalOpen()" 
    [title]="(editingId() ? 'แก้ไขข้อมูลพนักงาน' : 'เพิ่มพนักงานใหม่')"
    (onClose)="isModalOpen.set(false)">
    <form class="space-y-4" (ngSubmit)="handleSave(); $event.preventDefault()">
      @if (errorMessage()) {
        <div class="bg-red-50 border border-red-200 rounded-lg p-3 text-sm text-red-600">
          {{ errorMessage() }}
        </div>
      }

      <div class="space-y-4">
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <app-input
            type="text"
            label="ชื่อ-นามสกุล"
            [(ngModel)]="formData.name"
            name="name"
            [required]="true"
            [error]="fieldErrors()['name']">
          </app-input>
          <app-input
            type="tel"
            label="เบอร์โทรศัพท์"
            [(ngModel)]="formData.phone"
            name="phone"
            [error]="fieldErrors()['phone']">
          </app-input>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">แผนก *</label>
            <select 
              class="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 outline-none bg-white"
              [(ngModel)]="formData.departmentId"
              (ngModelChange)="onDepartmentChange($event)"
              name="departmentId"
              required>
              @for (dept of departments(); track dept.id) {
                <option [value]="dept.id">{{ dept.name }}</option>
              }
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">ตำแหน่ง *</label>
            <select 
              [class]="'w-full p-2 border rounded-md focus:ring-2 focus:ring-indigo-500 outline-none bg-white ' + (fieldErrors()['positionId'] ? 'border-red-300 focus:ring-red-500' : 'border-slate-300')"
              [(ngModel)]="formData.positionId"
              name="positionId"
              [disabled]="positions().length === 0"
              required>
              @if (positions().length === 0) {
                <option value="">กรุณาเลือกแผนกก่อน</option>
              } @else {
                @for (pos of positions(); track pos.id) {
                  <option [value]="pos.id">{{ pos.name }}</option>
                }
              }
            </select>
            @if (fieldErrors()['positionId']) {
              <p class="mt-1 text-xs text-red-600">{{ fieldErrors()['positionId'] }}</p>
            }
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">สถานะ *</label>
          <select 
            [class]="'w-full p-2 border rounded-md focus:ring-2 focus:ring-indigo-500 outline-none bg-white ' + (fieldErrors()['status'] ? 'border-red-300 focus:ring-red-500' : 'border-slate-300')"
            [(ngModel)]="formData.status"
            name="status"
            required>
            <option value="Active">Active</option>
            <option value="Inactive">Inactive</option>
          </select>
          @if (fieldErrors()['status']) {
            <p class="mt-1 text-xs text-red-600">{{ fieldErrors()['status'] }}</p>
          }
        </div>
      </div>

      <div class="flex flex-col-reverse sm:flex-row justify-end gap-3 mt-6 pt-4 border-t border-slate-100">
        <app-button variant="secondary" (onClick)="isModalOpen.set(false)" className="w-full sm:w-auto" [disabled]="isLoading()">ยกเลิก</app-button>
        <app-button variant="primary" (onClick)="handleSave()" className="w-full sm:w-auto" [disabled]="isLoading()">
          @if (isLoading()) {
            <app-icon name="loader-2" class="animate-spin" size="16"></app-icon>
            <span>กำลังบันทึก...</span>
          } @else {
            {{ editingId() ? 'อัปเดตข้อมูล' : 'สร้างบัญชี' }}
          }
        </app-button>
      </div>
    </form>
  </app-modal>

  <!-- Confirm Delete Modal -->
  <app-confirm-modal
    [isOpen]="isConfirmModalOpen()"
    title="ยืนยันการลบ"
    [message]="confirmMessage()"
    confirmText="ลบ"
    cancelText="ยกเลิก"
    variant="danger"
    (onConfirm)="handleConfirmDelete()"
    (onCancel)="handleCancelDelete()">
  </app-confirm-modal>
</div>
